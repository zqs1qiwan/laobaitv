name: Update Stream Playlist
on:
  schedule:
    - cron: '0 */3 * * *'  # æ¯ 3 å°æ—¶åœ¨æ•´ç‚¹è¿è¡Œï¼ˆUTC æ—¶é—´ï¼‰
  workflow_dispatch:        # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-playlist:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: 'repo'

      - name: Verify laobai file
        run: |
          if [ ! -f repo/stream/stream-laobai.m3u ]; then
            echo "::error::âŒ å…³é”®é”™è¯¯ï¼šrepo/stream/stream-laobai.m3u æ–‡ä»¶ä¸å­˜åœ¨ï¼"
            echo "è¯·åˆ›å»ºæ­¤æ–‡ä»¶å¹¶æäº¤åˆ°ä»“åº“"
            exit 1
          else
            echo "âœ… æ‰¾åˆ° stream-laobai.m3u æ–‡ä»¶"
            ls -la repo/stream/stream-laobai.m3u
          fi

      - name: Process target URLs
        working-directory: ./repo/stream
        run: |
          # åªåˆ é™¤è‡ªåŠ¨ç”Ÿæˆçš„ stream-*.m3u æ–‡ä»¶ï¼Œä¿ç•™è€ç™½æ–‡ä»¶å’Œæœ€ç»ˆæ–‡ä»¶
          find . -maxdepth 1 -name 'stream-[0-9]*.m3u' -delete
          rm -f temp_*.m3u
          
          # å¤„ç†éç©ºtarget
          if [ -s target.txt ]; then
            index=1
            while IFS= read -r url; do
              # æ¸…ç†URLæ ¼å¼
              url=$(echo "$url" | tr -d '\r' | xargs)
              [ -z "$url" ] && continue
              
              # ä¸‹è½½M3U
              if curl -sS --max-time 10 --retry 2 -o "temp_$index.m3u" "$url"; then
                # åŒé‡è¿‡æ»¤ï¼šç§»é™¤EXTM3Uå¤´ + å¹¿å‘Šé¢‘é“
                awk '
                  /^#EXTM3U/ { next }
                  /æµ‹è¯•/ && /^#EXTINF/ { skip=1; next }
                  skip { skip=0; next }
                  { print }
                ' "temp_$index.m3u" > "stream-$index.m3u"
              else
                echo "âš ï¸ Failed to download: $url"
              fi
              
              index=$((index + 1))
            done < target.txt
          else
            echo "â„¹ï¸ target.txt is empty, skipping downloads"
          fi
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f temp_*.m3u
          
          # åˆ—å‡ºå¤„ç†åçš„æ–‡ä»¶
          echo "å¤„ç†åçš„æ–‡ä»¶åˆ—è¡¨:"
          ls -la

      - name: Merge playlists
        working-directory: ./repo/stream
        run: |
          echo "åˆå¹¶å‰ç›®å½•å†…å®¹:"
          ls -la
          
          # åˆ›å»ºç©ºåˆå¹¶æ–‡ä»¶ï¼ˆä¸è¦ä»»ä½•å¤´ï¼‰
          > merged.tmp
          
          # æ·»åŠ è€ç™½å†…å®¹ï¼ˆè¿‡æ»¤æ‰EXTM3Uå’Œå¹¿å‘Šï¼‰
          echo "æ·»åŠ è€ç™½åˆ—è¡¨å†…å®¹..."
          awk '
            /^#EXTM3U/ { next }
            /æµ‹è¯•/ && /^#EXTINF/ { skip=1; next }
            skip { skip=0; next }
            { print }
          ' stream-laobai.m3u >> merged.tmp
          
          # æ·»åŠ è‡ªåŠ¨åˆ—è¡¨ï¼ˆå·²è¿‡æ»¤ï¼‰- åªæ·»åŠ  stream-æ•°å­—.m3u æ–‡ä»¶
          echo "æ·»åŠ è‡ªåŠ¨ç”Ÿæˆçš„åˆ—è¡¨..."
          # ä½¿ç”¨æ­£åˆ™ç¡®ä¿åªåŒ¹é…æ•°å­—ç¼–å·çš„æ–‡ä»¶
          for f in $(ls -v stream-[0-9]*.m3u 2>/dev/null | sort -V); do
            echo "æ·»åŠ æ–‡ä»¶: $f"
            cat "$f" >> merged.tmp
          done
          
          # æ™ºèƒ½æ›´æ–°æ£€æµ‹
          if [ -f stream.m3u ] && cmp -s merged.tmp stream.m3u; then
            rm merged.tmp
            echo "âœ… æ— å˜æ›´"
          else
            mv merged.tmp stream.m3u
            echo "ğŸ”„ æ’­æ”¾åˆ—è¡¨å·²æ›´æ–°"
          fi
          
          # æ˜¾ç¤ºæœ€ç»ˆæ–‡ä»¶å¤§å°
          echo "æœ€ç»ˆæ–‡ä»¶å¤§å°:"
          du -sh stream-laobai.m3u
          du -sh stream.m3u
          
          # æ˜¾ç¤ºå†…å®¹è¡Œæ•°ç”¨äºè°ƒè¯•
          echo "stream-laobai.m3u è¡Œæ•°: $(wc -l < stream-laobai.m3u)"
          echo "stream.m3u è¡Œæ•°: $(wc -l < stream.m3u)"

      - name: Commit changes
        if: success()
        run: |
          cd repo
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # æ·»åŠ è‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶
          git add stream/stream-[0-9]*.m3u  # åªæ·»åŠ æ•°å­—ç¼–å·æ–‡ä»¶
          git add stream/stream.m3u
          
          # æ°¸è¿œä¸è¦æäº¤è€ç™½æ–‡ä»¶çš„æ›´æ”¹
          git restore --staged stream/stream-laobai.m3u 2>/dev/null || true
          
          if git diff --cached --quiet; then
            echo "â© æ— å˜æ›´å¯æäº¤"
          else
            git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°æ’­æ”¾åˆ—è¡¨"
            git push
            echo "ğŸš€ å˜æ›´å·²æäº¤!"
          fi
